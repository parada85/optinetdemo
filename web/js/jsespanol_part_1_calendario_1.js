$(document).ready(function(){var A=Routing.generate("listarcitascalendario",{id:0});var B=Routing.generate("listararqueoscalendario",{idemp:0});$("#calendarioarqueo").fullCalendar({defaultView:"month",buttonText:{today:"Hoy",week:"Semana",day:"Dia"},columnFormat:{month:"dddd"},titleFormat:{week:"d[ yyyy]{ '&#8212;'[ MMM] d MMMM yyyy}",day:"dddd, d MMMM yyyy"},height:600,monthNames:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],dayNames:["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sabado"],axisFormat:"HH:mm",theme:true,height:450,defaultEventMinutes:120,weekends:false,header:{left:"prev,next today",center:"title"},eventSources:[{url:B}],eventRender:function(E,D){D.qtip({content:"Hora: "+E.hora+"<br/>Realizado por: "+E.empleado,show:{effect:function(G){$(this).slideDown(400)}}});if(E.efectivocontado!=null){var C=E.boletascontado-E.boletas;var F=E.efectivocontado-E.efectivo;F=Math.round(F*100)/100;D.find(".fc-event-title").append("<br/> Boletas: "+E.boletas+" Contadas: "+E.boletascontado+" Dif :"+C);D.find(".fc-event-title").append("<br/> Efectivo: "+E.efectivo+" Contado: "+E.efectivocontado+" Dif :"+F)}}});$("#calendar").fullCalendar({defaultView:"agendaWeek",buttonText:{today:"Hoy",week:"Semana",day:"Dia",},columnFormat:{week:"dddd d/M",day:"dddd d/M"},titleFormat:{week:"d[ yyyy]{ '&#8212;'[ MMM] d MMMM yyyy}",day:"dddd, d MMMM yyyy"},monthNames:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],dayNames:["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sabado"],axisFormat:"HH:mm",theme:true,height:9999999999,allDaySlot:false,firstHour:9,droppable:true,editable:true,disableResizing:true,defaultEventMinutes:30,minTime:9,maxTime:20,weekends:false,header:{left:"prev,next today",center:"title",right:"agendaWeek,agendaDay"},eventSources:[{url:A},{url:Routing.generate("festivosajax"),color:"red"}],eventDrop:function(C,F,J,R,H,K,M,N){var Q=new Date();if(C.start<Q){$("#erroranterior").wijdialog("open");setTimeout(function(){$(".qtip").remove()},1000);$("#calendar").fullCalendar("refetchEvents")}else{var G,E;date=C.start;var D=date.getMonth()+1;var I=date.getDate();var L=date.getFullYear();var P=date.toLocaleTimeString().toLowerCase().replace(/:\d\d ([ap]m) .+$/," $1");var O=I+"-"+D+"-"+L+" "+P;$.ajax({data:{fecha:O},url:Routing.generate("comprobarcitafestivo"),success:function(S){if(S==1){$.getJSON(Routing.generate("obtenerdatoscita"),{citaid:C.id},function(T){$.each(T,function(U,V){G=T[U].cliente;E=T[U].medico;$.ajax({data:{fecha:O,medico:E,cliente:G},url:Routing.generate("comprobarcita"),success:function(W){if(W==1){$.ajax({data:{fecha:O,medico:E,},url:Routing.generate("comprobarmedico1"),success:function(X){if(X==1){$.ajax({data:{fecha:O,idcita:C.id},url:Routing.generate("modificarcita")});setTimeout(function(){$("#calendar").fullCalendar("refetchEvents");tablacitas.fnReloadAjax()},1000)}else{$("#errorcita").wijdialog("open");$("#calendar").fullCalendar("refetchEvents")}}})}else{$("#errorcita").wijdialog("open");$("#calendar").fullCalendar("refetchEvents")}$(".qtip").remove()}})})})}else{$("#calendar").fullCalendar("refetchEvents");$(".qtip").remove()}}})}},eventRender:function(D,C){if(D.empleado!=null){if(D.color=="black"){C.draggable({disabled:true})}C.qtip({content:D.fecha+"<br/>Realizada por: "+D.empleado,show:{effect:function(E){$(this).slideDown(400)}}});C.find(".fc-event-title").append(" "+D.apellido1+"<br/>"+D.contacto)}},dayClick:function(C,L,F,H){var K=new Date();if(C<K){$("#erroranterior").wijdialog("open")}else{var D=C.getMonth()+1;var E=C.getDate();var G=C.getFullYear();var J=C.toLocaleTimeString().toLowerCase().replace(/:\d\d ([ap]m) .+$/," $1");var I=G+"-"+D+"-"+E+" "+J;$("#dialogonuevacita").data("fecha",I);$("#fechadialogo").html("Fecha: "+E+"/"+D+"/"+G+" "+J);$.ajax({data:{fecha:I},url:Routing.generate("comprobarcitafestivo"),success:function(M){if(M==1){$(".selectmedico").remove();$.getJSON(Routing.generate("comprobarmedico"),{fecha:I},function(N){$.each(N,function(O,P){$("#seleccionmedico").append("<option class='selectmedico' value='"+N[O].id+"'>"+N[O].nombre+"</option>")})});$("#dialogonuevacita").wijdialog("open");$(".th").click()}}})}},eventClick:function(E,D,C){if(E.title!="Festivo"&&E.color!="black"){$("#calendardialogedit").data("idcita",E.id);$("#calendardialogedit").wijdialog("open")}if(E.color=="black"){$.fancybox.open({href:Routing.generate("informepdf",{id:E.informe}),type:"iframe"})}}});$(".calendar").fullCalendar("option","aspectRatio",1.8);$("#calendar1").fullCalendar({defaultView:"month",buttonText:{today:"Hoy",week:"Semana",day:"Dia"},columnFormat:{month:"dddd"},titleFormat:{week:"d[ yyyy]{ '&#8212;'[ MMM] d MMMM yyyy}",day:"dddd, d MMMM yyyy"},height:600,monthNames:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],dayNames:["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sabado"],axisFormat:"HH:mm",theme:true,height:450,defaultEventMinutes:120,weekends:false,header:{left:"prev,next today",center:"title"},events:Routing.generate("festivosajax"),eventColor:"red",dayClick:function(C,L,G,I){var E=0;var D=C.getMonth()+1;var F=C.getDate();var H=C.getFullYear();var K=C.toLocaleTimeString().toLowerCase().replace(/:\d\d ([ap]m) .+$/," $1");var J=H+"-"+D+"-"+F+" 09:00:00";$("#festivos").data("fecha",J);$("#festivos").wijdialog("open")},eventClick:function(E,D,C){$("#borrarfestivo").data("idfestivo",E.id);$("#borrarfestivo").wijdialog("open")}});$("#calendar1").fullCalendar("option","aspectRatio",1.8);$("#calendar2").fullCalendar({defaultView:"agendaWeek",buttonText:{today:"Hoy",week:"Semana",day:"Dia"},columnFormat:{week:"dddd d/M",day:"dddd d/M"},titleFormat:{week:"d[ yyyy]{ '&#8212;'[ MMM] d MMMM yyyy}",day:"dddd, d MMMM yyyy"},monthNames:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],dayNames:["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sabado"],axisFormat:"HH:mm",theme:true,height:600,allDaySlot:false,firstHour:9,defaultEventMinutes:30,minTime:9,maxTime:20,weekends:false,header:{left:"prev,next today",center:"title",right:"agendaWeek,agendaDay"},eventSources:[{url:Routing.generate("listarcitascalendario",{id:$("#medicoinforme").text()})},{url:Routing.generate("festivosajax"),color:"red",}],eventRender:function(D,C){if(D.empleado!=null){C.qtip({content:D.fecha+"<br/>Realizada por: "+D.empleado,show:{effect:function(E){$(this).slideDown(400)}}});C.find(".fc-event-title").append(" "+D.apellido1+"<br/>"+D.contacto)}},eventClick:function(F,D,C){if(F.informe=="NO"){var E=Routing.generate("informe_new",{id:F.id,id1:F.id});window.location=E}else{$.fancybox.open({href:Routing.generate("informepdf",{id:F.informe}),type:"iframe"})}}});$("#calendar2").fullCalendar("option","aspectRatio",1.8);$("#vacaciones").fullCalendar({defaultView:"month",buttonText:{today:"Hoy",week:"Semana",day:"Dia"},columnFormat:{week:"dddd d/M",day:"dddd d/M",month:"dddd"},titleFormat:{week:"d[ yyyy]{ '&#8212;'[ MMM] d MMMM yyyy}",day:"dddd, d MMMM yyyy"},monthNames:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],dayNames:["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sabado"],axisFormat:"HH:mm",theme:true,height:600,firstDay:1,allDaySlot:false,editable:true,droppable:true,header:{left:"prev,next today",center:"title"},eventSources:[{url:Routing.generate("listarpermisoscalendario"),},{url:Routing.generate("festivosajax"),color:"red",}],drop:function(D,M,H,J){var F=$(this).data("eventObject");var C=$.extend({},F);C.start=D;C.allDay=M;$(this).effect("pulsate");var E=D.getMonth()+1;var G=D.getDate();var I=D.getFullYear();var L=D.toLocaleTimeString().toLowerCase().replace(/:\d\d ([ap]m) .+$/," $1");var K=I+"-"+E+"-"+G+" 09:00:00";$.ajax({data:{fecha:K,empleado:C.title,tipo:C.tipo,fin:"null",daydelta:"no",chivato:"no"},url:Routing.generate("comprobarpermiso"),success:function(N){if(N==1){$.ajax({url:Routing.generate("guardarpermiso"),data:{empleado:C.title,tipo:C.tipo,inicio:K,fin:"null"}});setTimeout(function(){$("#vacaciones").fullCalendar("refetchEvents")},1000)}else{if(N==2){alert("El empleado ya tiene ese tipo de vacaciones en este año")}else{alert("Error el empleado tiene un permiso en esa fecha")}}}})},eventDrop:function(C,D,F,K,E,G,H,I){var J=C.end;if(C.end==null){J="null"}$.ajax({data:{fecha:C.start,fin:J,empleado:C.title,tipo:C.tipo,daydelta:"no",chivato:"si"},url:Routing.generate("comprobarpermiso"),success:function(L){if(L==1){$.ajax({url:Routing.generate("borrarpermiso",{id:C.id})});$.ajax({url:Routing.generate("guardarpermiso"),data:{empleado:C.title,tipo:C.tipo,inicio:C.start,fin:J}})}else{alert("Error el empleado tiene un permiso en esa fecha")}}});setTimeout(function(){$("#vacaciones").fullCalendar("refetchEvents")},1000)},eventResize:function(C,D,F,K,E,G,H,I){var J=C.end;if(C.end==null){J="null"}if(D>0){$.ajax({data:{fecha:C.start,fin:J,empleado:C.title,tipo:C.tipo,daydelta:D-1,chivato:"no"},url:Routing.generate("comprobarpermiso"),success:function(L){if(L==1){$.ajax({url:Routing.generate("borrarpermiso",{id:C.id})});$.ajax({url:Routing.generate("guardarpermiso"),data:{empleado:C.title,tipo:C.tipo,inicio:C.start,fin:J}})}else{alert("Error el empleado tiene un permiso en esa fecha")}}});setTimeout(function(){$("#vacaciones").fullCalendar("refetchEvents")},1000)}else{$.ajax({url:Routing.generate("borrarpermiso",{id:C.id})});$.ajax({url:Routing.generate("guardarpermiso"),data:{empleado:C.title,tipo:C.tipo,inicio:C.start,fin:J}})}},eventClick:function(E,D,C){if(E.title!="Festivo"){$("#borrarpermiso").data("idpermiso",E.id);$("#borrarpermiso").wijdialog("open")}}});$("#vacaciones").fullCalendar("option","aspectRatio",1.8);$("#select1").change(function(){$("#calendar").fullCalendar("removeEventSource",A);A=Routing.generate("listarcitascalendario",{id:$("#select1").val()});$("#calendar").fullCalendar("addEventSource",A);$("#calendar").fullCalendar("refetchEvents")});$("#calendarioemparqueo").change(function(){$("#calendarioarqueo").fullCalendar("removeEventSource",B);B=Routing.generate("listararqueoscalendario",{idemp:$("#calendarioemparqueo").val()});$("#calendarioarqueo").fullCalendar("addEventSource",B);$("#calendarioarqueo").fullCalendar("refetchEvents")});$(".seleccionparacita").live("click",function(){var D=$("td",this.parentNode.parentNode);var E=$(D[0]).text();var C=$("#dialogonuevacita").data("fecha");$.ajax({data:{fecha:C,medico:$("#seleccionmedico").val(),cliente:E},url:Routing.generate("comprobarcita"),success:function(F){if(F==1){$("#ajax-loader").show();$.ajax({data:{fecha:C,medico:$("#seleccionmedico").val(),cliente:E},url:Routing.generate("guardarcita")});setTimeout(function(){$("#calendar").fullCalendar("refetchEvents");$("#dialogonuevacita").wijdialog("close");$("#ajax-loader").hide();tablacitas.fnReloadAjax()},1000)}else{$("#errorcita").wijdialog("open")}}})});$("div.invierno, div.verano, div.baja").each(function(){var C={title:$.trim($(this).text()),color:$(this).attr("id"),tipo:$(this).attr("class")};$(this).data("eventObject",C);$(this).draggable({zIndex:999,revert:true,revertDuration:0})});$(".botoninvierno").live("click",function(){$("#borrarpermisos").data("idpermiso","invierno");$("#borrarpermisos").wijdialog("open")});$(".botonverano").live("click",function(){$("#borrarpermisos").data("idpermiso","verano");$("#borrarpermisos").wijdialog("open")});$(".botonbaja").live("click",function(){$("#borrarpermisos").data("idpermiso","baja");$("#borrarpermisos").wijdialog("open")})});